import OpenAI from "openai";
import { FormData } from "@/types";

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY || "",
});

function cleanAndFormatResponse(text: string): string {
  const cleaned = text
    .replace(/\*{2,}/g, "")
    .replace(/\*([^*]+)\*/g, "<strong>$1</strong>")
    .replace(/#/g, "")
    .replace(/\n{3,}/g, "\n\n");

  return cleaned;
}

export async function analyzeWithChatGPT(formData: FormData): Promise<string> {
  try {
    const prompt = `
    אתה יועץ אסטרטגי בכיר המבצע ניתוח Deep Research מקיף ומעמיק.
    
    נתוני הלקוח:
    - שם העסק: ${formData.businessName}
    - הבעיה הנפתרת: ${formData.problem}
    - הפתרון המוצע: ${formData.solution}
    - קהל היעד: ${formData.targetMarket}
    
    בצע ניתוח מקיף הכולל:
    
    1. תקציר מנהלים (200 מילים)
    - ממצאים והמלצות מרכזיות
    - ציון פוטנציאל השקעה (1-10)
    - גורמי הצלחה קריטיים
    
    2. ניתוח שוק מעמיק (800+ מילים)
    2.1 גודל השוק:
    - TAM: חשב בגישת bottom-up ו-top-down
    - SAM: הגדר שוק זמין עם קריטריונים ברורים
    - SOM: תחזית ריאלית ל-3 שנים
    - כלול נתונים וחישובים ספציפיים
    
    2.2 דינמיקת השוק:
    - קצב צמיחה (CAGR) עם נתונים היסטוריים
    - מניעי שוק מרכזיים (רשימה של 5+)
    - חסמי שוק ואתגרים
    - שיקולים רגולטוריים
    
    2.3 ניתוח מגמות:
    - מגמות טכנולוגיות המשפיעות על השוק
    - שינויים בהתנהגות צרכנים
    - התפתחות השוק בעתיד (תחזית 5 שנים)
    
    3. ניתוח תחרותי מקיף (600+ מילים)
    3.1 מיפוי מתחרים:
    - מתחרים ישירים (מינימום 10)
    - מתחרים עקיפים (מינימום 5)
    - פתרונות תחליפיים
    
    3.2 מטריצה תחרותית:
    צור טבלת השוואה מפורטת הכוללת:
    - יכולות ותכונות
    - מודלי תמחור
    - הערכות נתח שוק
    - חוזקות וחולשות
    
    3.3 אסטרטגיית בידול:
    - הצעת ערך ייחודית
    - יתרונות תחרותיים
    - אסטרטגיית מיצוב
    
    4. ניתוח מודל עסקי (500+ מילים)
    4.1 מודל הכנסות:
    - זרמי הכנסה עיקריים
    - אסטרטגיית תמחור והצדקה
    - הערכת עלות רכישת לקוח (CAC)
    - תחזית ערך חיי לקוח (LTV)
    
    4.2 תחזיות פיננסיות:
    - תחזית רווח והפסד ל-3 שנים
    - ניתוח נקודת איזון עם ציר זמן
    - פירוט יחידה כלכלית (Unit Economics)
    - הנחות מפתח ורגישויות
    
    4.3 הערכת יכולת הרחבה:
    - פוטנציאל צמיחה
    - מינוף תפעולי
    - דרישות משאבים
    
    5. מסגרות אסטרטגיות (400+ מילים)
    5.1 חמשת הכוחות של פורטר:
    - איום כניסת מתחרים חדשים
    - כוח מיקוח של ספקים
    - כוח מיקוח של קונים
    - איום מוצרים תחליפיים
    - עוצמת התחרות בענף
    
    5.2 ניתוח SWOT:
    - חוזקות (5+ נקודות)
    - חולשות (5+ נקודות)
    - הזדמנויות (5+ נקודות)
    - איומים (5+ נקודות)
    
    6. ניתוח לקוחות (300+ מילים)
    - פרסונות לקוחות (3 פרופילים מפורטים)
    - מיפוי מסע הלקוח
    - ניתוח נקודות כאב וצרכים
    - הערכת נכונות לתשלום
    
    7. אסטרטגיית כניסה לשוק (400+ מילים)
    - גישת כניסה לשוק
    - אסטרטגיית ערוצים
    - תמהיל שיווקי (4Ps)
    - טקטיקות רכישת לקוחות
    - הזדמנויות לשותפויות
    
    8. הערכת סיכונים (300+ מילים)
    - סיכוני שוק
    - סיכונים טכנולוגיים
    - סיכונים פיננסיים
    - סיכונים תפעוליים
    - אסטרטגיות הפחתה לכל סיכון
    
    9. אבני דרך ומדדים מרכזיים
    - מפת דרכים ל-12 חודשים עם יעדים ספציפיים
    - מדדי ביצוע מרכזיים (KPIs)
    - מדדי הצלחה ונקודות ייחוס
    
    10. המלצות סופיות
    - המלצת השקעה (כן/לא/מותנה)
    - פעולות קריטיות ל-90 הימים הקרובים
    - עדיפויות אסטרטגיות לטווח ארוך
    
    דרישות חשובות מאוד:
    1. אסור לחלוטין להשתמש בסימני כוכבית (*) בתשובה - גם לא להדגשה
    2. להדגשה יש להשתמש בתגי <strong></strong> בלבד
    3. אין להשתמש בסימני # או האשטג בכל התשובה
    4. להשתמש בנקודות תבליט רגילות (-)
    5. שמור על עיצוב נקי ומקצועי
    6. יש לספק דוגמאות ספציפיות ונתונים מספריים
    7. יש לשמור על פורמט מסודר עם כותרות וכותרות משנה 
    8. להימנע מכל סימני עיצוב מיותרים
    
    התגובה חייבת להיות מעוצבת בצורה מקצועית לחלוטין ללא כל שימוש בכוכביות, האשטגים או סימנים מיוחדים.
    `;

    const response = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [
        {
          role: "system",
          content:
            "אתה יועץ אסטרטגי מקצועי המבצע ניתוחי שוק מעמיקים. תענה בעברית בלבד.",
        },
        {
          role: "user",
          content: prompt,
        },
      ],
      temperature: 0.7,
    });

    const content = response.choices[0]?.message?.content || "";
    return cleanAndFormatResponse(content);
  } catch (error: unknown) {
    console.error("Error calling ChatGPT API:", error);
    const errorMessage = error instanceof Error ? error.message : String(error);
    return `<p class="text-red-500">שגיאה בקבלת ניתוח מ-ChatGPT: ${errorMessage}</p>`;
  }
}
